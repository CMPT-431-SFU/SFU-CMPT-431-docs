



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Arrvindh Shriraman">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>SFU CMPT 431 memory debugging - SFU CMPT 431 Parallel and Distributed Systems</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#how-to-debug-memory-problems" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SFU CMPT 431 Parallel and Distributed Systems" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              SFU CMPT 431 Parallel and Distributed Systems
            </span>
            <span class="md-header-nav__topic">
              
                SFU CMPT 431 memory debugging
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/SFU-CMPT-431/SFU-CMPT-431-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SFU-CMPT-431/SFU-CMPT-431-docs
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../SFU-CMPT-431-T01-intro-c/" class="md-tabs__link">
          Topic Notes
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../SFU-CMPT-431-sec1-linux/" class="md-tabs__link">
          Section Notes
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SFU CMPT 431 Parallel and Distributed Systems" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    SFU CMPT 431 Parallel and Distributed Systems
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/SFU-CMPT-431/SFU-CMPT-431-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    SFU-CMPT-431/SFU-CMPT-431-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Topic Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Topic Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../SFU-CMPT-431-T01-intro-c/" title="Topic 1: Introduction to C" class="md-nav__link">
      Topic 1: Introduction to C
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Section Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Section Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../SFU-CMPT-431-sec1-linux/" title="Section 1: Linux Development Environment" class="md-nav__link">
      Section 1: Linux Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../SFU-CMPT-431-sec2-c-basics/" title="Section 2: Compiling and Running C Programs" class="md-nav__link">
      Section 2: Compiling and Running C Programs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../SFU-CMPT-431-sec3-c-build-test/" title="Section 3: C Build and Test Frameworks" class="md-nav__link">
      Section 3: C Build and Test Frameworks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../SFU-CMPT-431-sec4-c-test-debug/" title="Section 4: C Testing and Debugging" class="md-nav__link">
      Section 4: C Testing and Debugging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-memory-leak" class="md-nav__link">
    1. Memory leak
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-double-free-your-memory" class="md-nav__link">
    2. Double free your memory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-invalid-memory-access" class="md-nav__link">
    3. Invalid memory access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-use-valgrind-in-your-pas" class="md-nav__link">
    How to use valgrind in your PAs
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/SFU-CMPT-431/SFU-CMPT-431-docs/edit/master/docs/SFU-CMPT-431-memory-debugging.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="how-to-debug-memory-problems">How to debug memory problems?<a class="headerlink" href="#how-to-debug-memory-problems" title="Permanent link">&para;</a></h1>
<p>Author: Tuan Ta<br />
Date  : Sep 26, 2018</p>
<p>While dynamic memory allocation gives us a lot of freedom in keeping some blocks
of memory alive across function calls, misusing dynamically allocated memory is
often the most common cause of memory corruptions (e.g., segmentation fault). In
this tutorial, I'll walk you through some common mistakes in using dynamic
memory allocation and pointer. For each mistake, I'll show you how to detect it
using a powerful memory checking tool called <em>valgrind</em>.</p>
<h2 id="1-memory-leak">1. Memory leak<a class="headerlink" href="#1-memory-leak" title="Permanent link">&para;</a></h2>
<p>Let's consider this program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span> <span class="nt">1</span> <span class="p">#</span><span class="nn">include</span> <span class="o">&lt;</span><span class="nt">stdlib</span><span class="p">.</span><span class="nc">h</span><span class="o">&gt;</span>
 <span class="nt">2</span> <span class="p">#</span><span class="nn">include</span> <span class="o">&lt;</span><span class="nt">stdio</span><span class="p">.</span><span class="nc">h</span><span class="o">&gt;</span>
 <span class="nt">3</span>
 <span class="nt">4</span> <span class="nt">int</span> <span class="nt">main</span><span class="o">(</span> <span class="nt">void</span> <span class="o">)</span> <span class="p">{</span>
 <span class="err">5</span>
 <span class="err">6</span>   <span class="err">//</span> <span class="err">Allocate</span> <span class="err">an</span> <span class="err">int</span> <span class="err">on</span> <span class="err">the</span> <span class="err">heap</span>
 <span class="err">7</span>   <span class="err">int*</span> <span class="err">mem_ptr</span> <span class="err">=</span> <span class="err">(</span> <span class="err">int*</span> <span class="err">)</span> <span class="err">malloc(</span> <span class="err">sizeof(</span> <span class="err">int)</span> <span class="err">)</span><span class="p">;</span>
 <span class="err">8</span>
 <span class="err">9</span>   <span class="err">//</span> <span class="err">Initialize</span> <span class="err">that</span> <span class="err">int</span> <span class="err">variable</span>
<span class="err">10</span>   <span class="err">*mem_ptr</span> <span class="err">=</span> <span class="err">10</span><span class="p">;</span>
<span class="err">11</span>
<span class="err">12</span>   <span class="err">printf(&quot;</span> <span class="n">Before</span><span class="p">:</span> <span class="n">mem_ptr</span><span class="o">:</span> <span class="n">address</span> <span class="o">=</span> <span class="o">%</span><span class="n">lx</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="s2">&quot;, mem_ptr, *mem_ptr);</span>
<span class="s2">13</span>
<span class="s2">14   // Declare a new int variable on the stack</span>
<span class="s2">15   int a = 20;</span>
<span class="s2">16</span>
<span class="s2">17   // Reuse mem_ptr to point to &quot;</span><span class="n">a</span><span class="s2">&quot;</span>
<span class="s2">18   mem_ptr = &amp;a;</span>
<span class="s2">19</span>
<span class="s2">20   printf(&quot;</span> <span class="n">After</span><span class="o">:</span> <span class="n">mem_ptr</span><span class="o">:</span> <span class="n">address</span> <span class="o">=</span> <span class="o">%</span><span class="n">lx</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="err">21</span>
<span class="err">22</span>   <span class="err">//</span> <span class="err">How</span> <span class="err">do</span> <span class="err">I</span> <span class="err">get</span> <span class="err">back</span> <span class="err">my</span> <span class="err">memory</span> <span class="err">on</span> <span class="err">the</span> <span class="err">heap?</span>
<span class="err">23</span>
<span class="err">24</span>   <span class="err">return</span> <span class="err">0</span><span class="p">;</span>
<span class="err">25</span> <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>We first allocate a block of memory on the heap (in line 7). Then, we assign
mem_ptr to point to a different block of memory on the stack (in line 18). By
assigning "mem_ptr" to a different block of memory, we lose the only way to go
back to our heap memory block. Therefore, in line 22, we cannot free that heap
memory block.</p>
<p>There're actually two problems here:</p>
<ul>
<li>
<p>First, since there is no pointer pointing to the block of memory on the heap,
that block of memory becomes "orphan".</p>
</li>
<li>
<p>Second, since we do not or cannot free the block of memory, we lose it in our
program. This problem is called "memory leak".</p>
</li>
</ul>
<p>Now, let's compile and run the program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % gcc -Wall -g -O3 -o mem-leak mem-leak.c
ECE2400: ~/SFU-CMPT-431/tests % ./mem-leak
 Before: mem_ptr: address = 0x1a17010, value = 10
 After: mem_ptr: address = 0x7fffabe3582c, value = 20
</pre></div>
</td></tr></table>

<p>Notice that there is no compilation error! And our program runs "completely
fine", or does it?</p>
<p>Well, if your memory leak is small enough (e.g., in this program, we lose only 4
bytes of memory), then your program may not crash. Think about if your memory
leak accumulates over time in a long program, then something nasty (e.g.,
segmentation fault) will happen! We don't want that.</p>
<p>So how to detect memory leak. Luckily, we have a powerful tool called "Valgrind"
to help us. Let's use the tool to run our buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % valgrind --leak-check=full --error-exitcode=1 ./mem-leak
==14973== Memcheck, a memory error detector
==14973== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.
==14973== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==14973== Command: ./mem-leak
==14973==
 Before: mem_ptr: address = 0x5202040, value = 10
 After: mem_ptr: address = 0xffefff4dc, value = 20
==14973==
==14973== HEAP SUMMARY:
==14973==     in use at exit: 4 bytes in 1 blocks
==14973==   total heap usage: 1 allocs, 0 frees, 4 bytes allocated
==14973==
==14973== 4 bytes in 1 blocks are definitely lost in loss record 1 of 1
==14973==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)
==14973==    by 0x40047D: main (mem-leak.c:7)
==14973==
==14973== LEAK SUMMARY:
==14973==    definitely lost: 4 bytes in 1 blocks
==14973==    indirectly lost: 0 bytes in 0 blocks
==14973==      possibly lost: 0 bytes in 0 blocks
==14973==    still reachable: 0 bytes in 0 blocks
==14973==         suppressed: 0 bytes in 0 blocks
==14973==
==14973== For counts of detected and suppressed errors, rerun with: -v
==14973== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</pre></div>
</td></tr></table>

<p>Here I run <em>valgrind</em> with two options <em>--leak-check=full</em> that tells <em>valgrind</em>
to give details about any possible memory leak in our program and
<em>--error-exitcode=1</em> that tells <em>valgrind</em> to return an error code of 1 if any
memory error is detected.</p>
<p>Let's dive into what <em>valgrind</em> is telling us here. We thought our program ran
fine, but Valgrind reported that we "definitely lost" 4 bytes of memory on the
heap and that no memory block on the heap was "still reachable" at the end of
the program. The report tells us exactly what we expect in the buggy program
right? Our heap memory block has no pointer pointing to it at the end of the
program, so it is not reachable. Since there is no way to reach to the block, we
could not free that block. Therefore, that block of heap memory is definitely
lost.</p>
<p>When you compile your program with <em>-g</em> option, <em>valgrind</em> can tell you where
the leak exactly is in our program. In this case, we lost 4 bytes that were
allocated in line 7 of <em>mem-leak.c</em>.</p>
<p>Let's try to fix the memory bug and re-run <em>valgrind</em> on your own to verify the
leak is actually fixed.</p>
<h2 id="2-double-free-your-memory">2. Double free your memory<a class="headerlink" href="#2-double-free-your-memory" title="Permanent link">&para;</a></h2>
<p>Another common problem is that a block of memory on the heap can be freed twice.
Let's look at this buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span> <span class="nt">1</span> <span class="p">#</span><span class="nn">include</span> <span class="o">&lt;</span><span class="nt">stdlib</span><span class="p">.</span><span class="nc">h</span><span class="o">&gt;</span>
 <span class="nt">2</span> <span class="p">#</span><span class="nn">include</span> <span class="o">&lt;</span><span class="nt">stdio</span><span class="p">.</span><span class="nc">h</span><span class="o">&gt;</span>
 <span class="nt">3</span>
 <span class="nt">4</span> <span class="nt">void</span> <span class="nt">foo</span><span class="o">(</span> <span class="nt">int</span><span class="o">*</span> <span class="nt">mem_ptr</span> <span class="o">)</span> <span class="p">{</span>
 <span class="err">5</span>   <span class="err">printf(&quot;In</span> <span class="err">foo():</span> <span class="n">mem_ptr</span><span class="p">:</span> <span class="n">address</span> <span class="o">=</span> <span class="o">%</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="s2">&quot;, mem_ptr, *mem_ptr);</span>
<span class="s2"> 6   free( mem_ptr );</span>
<span class="s2"> 7 }</span>
<span class="s2"> 8</span>
<span class="s2"> 9 int main( void ) {</span>
<span class="s2">10</span>
<span class="s2">11   // Allocate an int on the heap</span>
<span class="s2">12   int* mem_ptr = ( int* ) malloc( sizeof( int) );</span>
<span class="s2">13</span>
<span class="s2">14   // Initialize that int variable</span>
<span class="s2">15   *mem_ptr = 10;</span>
<span class="s2">16</span>
<span class="s2">17   printf(&quot;</span><span class="n">In</span> <span class="nf">main</span><span class="p">()</span><span class="o">:</span> <span class="n">mem_ptr</span><span class="o">:</span> <span class="n">address</span> <span class="o">=</span> <span class="o">%</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">%</span><span class="n">d</span><span class="err">\</span><span class="n">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="n">mem_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="err">18</span>
<span class="err">19</span>   <span class="err">//</span> <span class="err">Call</span> <span class="err">foo</span>
<span class="err">20</span>   <span class="err">foo(</span> <span class="err">mem_ptr</span> <span class="err">)</span><span class="p">;</span>
<span class="err">21</span>
<span class="err">22</span>   <span class="err">//</span> <span class="err">Did</span> <span class="err">foo</span> <span class="err">free</span> <span class="err">mem_ptr?</span> <span class="err">Maybe</span> <span class="err">not,</span> <span class="err">so</span> <span class="err">let&#39;s</span> <span class="err">just</span> <span class="err">free</span> <span class="err">it</span> <span class="err">here</span> <span class="err">just</span> <span class="err">in</span> <span class="err">case!</span>
<span class="err">23</span>   <span class="err">free(</span> <span class="err">mem_ptr</span> <span class="err">)</span><span class="p">;</span>
<span class="err">24</span>
<span class="err">25</span>   <span class="err">return</span> <span class="err">0</span><span class="p">;</span>
<span class="err">26</span> <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>In line 12, we allocate a block of memory on the heap. In line 20, we pass
"mem_ptr" to <em>foo()</em>. In line 6, <em>foo()</em> after printing the value pointed by
"mem_ptr" frees the block. In line 23, <em>main()</em> tries to re-free "mem_ptr". You
may think that in this small program, it's easy to see that "mem_ptr" is freed
twice, right? In reality, it may be really hard to see this problem especially
when multiple pointers point to the same block of memory (i.e., this is called
pointer aliasing).</p>
<p>Let's run the program and see what will happen:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % gcc -Wall -g -O3 -o double-free double-free.c
ECE2400: ~/SFU-CMPT-431/tests % ./double-free
In main(): mem_ptr: address = 0xcec010, value = 10
In foo(): mem_ptr: address = 0xcec010, value = 10
*** Error in `./double-free&#39;: double free or corruption (fasttop): 0x0000000000cec010 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x81429)[0x7f5564d81429]
./double-free[0x4004f8]
/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f5564d223d5]
./double-free[0x400525]
======= Memory map: ========
00400000-00401000 r-xp 00000000 00:28 190587185                          /home/qtt2/SFU-CMPT-431/tests/double-free
00600000-00601000 r--p 00000000 00:28 190587185                          /home/qtt2/SFU-CMPT-431/tests/double-free
00601000-00602000 rw-p 00001000 00:28 190587185                          /home/qtt2/SFU-CMPT-431/tests/double-free
00cec000-00d0d000 rw-p 00000000 00:00 0                                  [heap]
7f5560000000-7f5560021000 rw-p 00000000 00:00 0
7f5560021000-7f5564000000 ---p 00000000 00:00 0
7f5564aea000-7f5564aff000 r-xp 00000000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7f5564aff000-7f5564cfe000 ---p 00015000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7f5564cfe000-7f5564cff000 r--p 00014000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7f5564cff000-7f5564d00000 rw-p 00015000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7f5564d00000-7f5564ec3000 r-xp 00000000 fd:00 148997                     /usr/lib64/libc-2.17.so
7f5564ec3000-7f55650c2000 ---p 001c3000 fd:00 148997                     /usr/lib64/libc-2.17.so
7f55650c2000-7f55650c6000 r--p 001c2000 fd:00 148997                     /usr/lib64/libc-2.17.so
7f55650c6000-7f55650c8000 rw-p 001c6000 fd:00 148997                     /usr/lib64/libc-2.17.so
7f55650c8000-7f55650cd000 rw-p 00000000 00:00 0
7f55650cd000-7f55650ef000 r-xp 00000000 fd:00 148990                     /usr/lib64/ld-2.17.so
7f55652c6000-7f55652c9000 rw-p 00000000 00:00 0
7f55652eb000-7f55652ee000 rw-p 00000000 00:00 0
7f55652ee000-7f55652ef000 r--p 00021000 fd:00 148990                     /usr/lib64/ld-2.17.so
7f55652ef000-7f55652f0000 rw-p 00022000 fd:00 148990                     /usr/lib64/ld-2.17.so
7f55652f0000-7f55652f1000 rw-p 00000000 00:00 0
7ffeec44c000-7ffeec46e000 rw-p 00000000 00:00 0                          [stack]
7ffeec485000-7ffeec487000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
Aborted (core dumped)
</pre></div>
</td></tr></table>

<p>Oopps, our program crashed! No worries. Our friend <em>valgrind</em> can help us detect what went wrong. Let's run <em>valgrind</em> and see what it reports.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % valgrind --leak-check=full --error-exitcode=1 ./double-free
==23220== Memcheck, a memory error detector
==23220== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.
==23220== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==23220== Command: ./double-free
==23220==
In main(): mem_ptr: address = 0x5202040, value = 10
In foo(): mem_ptr: address = 0x5202040, value = 10
==23220== Invalid free() / delete / delete[] / realloc()
==23220==    at 0x4C2AC7D: free (vg_replace_malloc.c:530)
==23220==    by 0x4004F7: main (double-free.c:23)
==23220==  Address 0x5202040 is 0 bytes inside a block of size 4 free&#39;d
==23220==    at 0x4C2AC7D: free (vg_replace_malloc.c:530)
==23220==    by 0x4004EF: main (double-free.c:20)
==23220==  Block was alloc&#39;d at
==23220==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)
==23220==    by 0x4004CA: main (double-free.c:12)
==23220==
==23220==
==23220== HEAP SUMMARY:
==23220==     in use at exit: 0 bytes in 0 blocks
==23220==   total heap usage: 1 allocs, 2 frees, 4 bytes allocated
==23220==
==23220== All heap blocks were freed -- no leaks are possible
==23220==
==23220== For counts of detected and suppressed errors, rerun with: -v
==23220== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</pre></div>
</td></tr></table>

<p>Valgrind tells us that there was an "invalid free()" in line 23 of
<em>double-free.c</em>. Thanks to Valgrind, now you know exactly what the problem is.
Can you fix it on your own and re-run valgrind?</p>
<h2 id="3-invalid-memory-access">3. Invalid memory access<a class="headerlink" href="#3-invalid-memory-access" title="Permanent link">&para;</a></h2>
<p>Remember that C compiler does not check out-of-bounds array access. You may
accidentally access some memory blocks that are not allocated. Let's consider
this buggy program:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span> 1 #include &lt;stdlib.h&gt;
 2 #include &lt;stdio.h&gt;
 3
 4 int main( void ) {
 5
 6   const int size = 10;
 7   int* mem_ptr = ( int* ) malloc( sizeof( int ) * size );
 8
 9   for ( int i = 0; i &lt;= size; i++ ) {
10     printf( &quot;Initializing mem_ptr[%d] ... \n&quot;, i );
11     mem_ptr[i] = i;
12   }
13
14   // Print out the array
15   for ( int i = 0; i &lt;= size; i++ ) {
16     printf( &quot;mem_ptr[%d] = %d\n&quot;, i, mem_ptr[i] );
17   }
18
19   // Free mem_ptr
20   free(mem_ptr);
21
22   return 0;
23 }
</pre></div>
</td></tr></table>

<p>Notice that the program allocates an array of 10 "int" elements on the heap (in
line 7). It by mistake initializes the 11th element when <em>i == size</em> in line 9.
Then in line 15, the program tries to read that unallocated element. When you compile and run the program, you will get something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % gcc -Wall -g -O3 -o out-of-bound-access out-of-bound-access.c
ECE2400: ~/SFU-CMPT-431/tests % ./out-of-bound-access
Initializing mem_ptr[0] ...
Initializing mem_ptr[1] ...
Initializing mem_ptr[2] ...
Initializing mem_ptr[3] ...
Initializing mem_ptr[4] ...
Initializing mem_ptr[5] ...
Initializing mem_ptr[6] ...
Initializing mem_ptr[7] ...
Initializing mem_ptr[8] ...
Initializing mem_ptr[9] ...
Initializing mem_ptr[10] ...
mem_ptr[0] = 0
mem_ptr[1] = 1
mem_ptr[2] = 2
mem_ptr[3] = 3
mem_ptr[4] = 4
mem_ptr[5] = 5
mem_ptr[6] = 6
mem_ptr[7] = 7
mem_ptr[8] = 8
mem_ptr[9] = 9
mem_ptr[10] = 10
*** Error in `./out-of-bound-access&#39;: free(): invalid next size (fast): 0x0000000001d1e010 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x81429)[0x7fdf3ec46429]
./out-of-bound-access[0x400524]
/lib64/libc.so.6(__libc_start_main+0xf5)[0x7fdf3ebe73d5]
./out-of-bound-access[0x400556]
======= Memory map: ========
00400000-00401000 r-xp 00000000 00:28 190587184                          /home/qtt2/SFU-CMPT-431/tests/out-of-bound-access
00600000-00601000 r--p 00000000 00:28 190587184                          /home/qtt2/SFU-CMPT-431/tests/out-of-bound-access
00601000-00602000 rw-p 00001000 00:28 190587184                          /home/qtt2/SFU-CMPT-431/tests/out-of-bound-access
01d1e000-01d3f000 rw-p 00000000 00:00 0                                  [heap]
7fdf38000000-7fdf38021000 rw-p 00000000 00:00 0
7fdf38021000-7fdf3c000000 ---p 00000000 00:00 0
7fdf3e9af000-7fdf3e9c4000 r-xp 00000000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7fdf3e9c4000-7fdf3ebc3000 ---p 00015000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7fdf3ebc3000-7fdf3ebc4000 r--p 00014000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7fdf3ebc4000-7fdf3ebc5000 rw-p 00015000 fd:00 1188523                    /usr/lib64/libgcc_s-4.8.5-20150702.so.1
7fdf3ebc5000-7fdf3ed88000 r-xp 00000000 fd:00 148997                     /usr/lib64/libc-2.17.so
7fdf3ed88000-7fdf3ef87000 ---p 001c3000 fd:00 148997                     /usr/lib64/libc-2.17.so
7fdf3ef87000-7fdf3ef8b000 r--p 001c2000 fd:00 148997                     /usr/lib64/libc-2.17.so
7fdf3ef8b000-7fdf3ef8d000 rw-p 001c6000 fd:00 148997                     /usr/lib64/libc-2.17.so
7fdf3ef8d000-7fdf3ef92000 rw-p 00000000 00:00 0
7fdf3ef92000-7fdf3efb4000 r-xp 00000000 fd:00 148990                     /usr/lib64/ld-2.17.so
7fdf3f18b000-7fdf3f18e000 rw-p 00000000 00:00 0
7fdf3f1b0000-7fdf3f1b3000 rw-p 00000000 00:00 0
7fdf3f1b3000-7fdf3f1b4000 r--p 00021000 fd:00 148990                     /usr/lib64/ld-2.17.so
7fdf3f1b4000-7fdf3f1b5000 rw-p 00022000 fd:00 148990                     /usr/lib64/ld-2.17.so
7fdf3f1b5000-7fdf3f1b6000 rw-p 00000000 00:00 0
7ffe872bd000-7ffe872df000 rw-p 00000000 00:00 0                          [stack]
7ffe872e7000-7ffe872e9000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
Aborted (core dumped)
</pre></div>
</td></tr></table>

<p>The program crashed at the very end when it tried to free an unallocated memory block. Let's run it using valgrind:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>ECE2400: ~/SFU-CMPT-431/tests % valgrind --leak-check=full --error-exitcode=1 ./out-of-bound-access
==31457== Memcheck, a memory error detector
==31457== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Julian Seward et al.
==31457== Using Valgrind-3.12.0 and LibVEX; rerun with -h for copyright info
==31457== Command: ./out-of-bound-access
==31457==
Initializing mem_ptr[0] ...
Initializing mem_ptr[1] ...
Initializing mem_ptr[2] ...
Initializing mem_ptr[3] ...
Initializing mem_ptr[4] ...
Initializing mem_ptr[5] ...
Initializing mem_ptr[6] ...
Initializing mem_ptr[7] ...
Initializing mem_ptr[8] ...
Initializing mem_ptr[9] ...
Initializing mem_ptr[10] ...
==31457== Invalid write of size 4
==31457==    at 0x4004E6: main (out-of-bound-access.c:11)
==31457==  Address 0x5202068 is 0 bytes after a block of size 40 alloc&#39;d
==31457==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)
==31457==    by 0x4004D1: main (out-of-bound-access.c:7)
==31457==
mem_ptr[0] = 0
mem_ptr[1] = 1
mem_ptr[2] = 2
mem_ptr[3] = 3
mem_ptr[4] = 4
mem_ptr[5] = 5
mem_ptr[6] = 6
mem_ptr[7] = 7
mem_ptr[8] = 8
mem_ptr[9] = 9
==31457== Invalid read of size 4
==31457==    at 0x400500: main (out-of-bound-access.c:16)
==31457==  Address 0x5202068 is 0 bytes after a block of size 40 alloc&#39;d
==31457==    at 0x4C29B83: malloc (vg_replace_malloc.c:299)
==31457==    by 0x4004D1: main (out-of-bound-access.c:7)
==31457==
mem_ptr[10] = 10
==31457==
==31457== HEAP SUMMARY:
==31457==     in use at exit: 0 bytes in 0 blocks
==31457==   total heap usage: 1 allocs, 1 frees, 40 bytes allocated
==31457==
==31457== All heap blocks were freed -- no leaks are possible
==31457==
==31457== For counts of detected and suppressed errors, rerun with: -v
==31457== ERROR SUMMARY: 2 errors from 2 contexts (suppressed: 0 from 0)
</pre></div>
</td></tr></table>

<p>Valgrind reported an "Invalid write of size 4" in line 11 and an "Invalid read
of size 4" in line 16. They're exactly where we by mistake accessed data blocks
outside our allocated array.</p>
<p>Now, you can hopefully clearly see the bug and fix it on your own.</p>
<h2 id="how-to-use-valgrind-in-your-pas">How to use valgrind in your PAs<a class="headerlink" href="#how-to-use-valgrind-in-your-pas" title="Permanent link">&para;</a></h2>
<p>In PAs, we provide you a make target called "make memcheck" that you can use to do memory check on your tests. You can do like this</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c">% # go to your PA directory</span>
<span class="c">% cd ${HOME}/SFU-CMPT-431/&lt;netid&gt;/pa2-dstruct</span>
<span class="c">% mkdir -p build</span>
<span class="c">% cd build</span>
<span class="c">% # run memcheck on all tests</span>
<span class="c">% make memcheck</span>
<span class="c">% # run memcheck on a single test (e.g., dlist-basic-tests)</span>
<span class="c">% make memcheck-dlist-basic-tests</span>
<span class="c">% # see reports generated by Valgrind</span>
<span class="c">% cd memtest-logs</span>
<span class="c">% geany dlist-basic-tests.log &amp;</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright for original site &copy; 2018 Christopher Batten
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../js/extras.js"></script>
      
    
  </body>
</html>